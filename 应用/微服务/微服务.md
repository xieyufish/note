## 微服务

### 什么是微服务

微服务（Microservices）是一种软件架构风格，它是以专注于单一责任与功能的小型功能区块为基础，是一种以业务功能为主的服务设计概念，每一个服务都具有自主运行的业务功能，将每个服务以模块化的方式组合成复杂的大型应用程序，各功能模块之间通过使用与语言无关的通信协议相互通讯实现最终的功能。

微服务架构的思考是从与整体应用对比而产生的。

![0](images\0.jpg)

其中，对应用组件封装的方式是整体架构与微服务架构的主要差异，微服务架构将相关联的业务逻辑及数据放在一起形成独立的边界，其目的是能在不影响其他应用组件(微服务)的情况下更快地交付并推出市场。

![1](images\1.jpg)

### 为什么需要微服务

传统IT架构面临的一些问题：

- 使用传统的整体式架构应用开发系统，如CRM、ERP等大型应用，随着新需求的不断增加，企业更新和修复大型整体式应用变得越来越困难；
- 移动互联网的发展使得企业将应用迁移至现代化UI界面结构以便兼容移动设备要求企业能实现应用功能的快速上线；
- 企业在SOA投资中得到的回报有限，SOA可以通过标准化服务接口实现能力的重用，但对于快速变化的需求，受到整体式应用的限制，有时候显得力不从心；
- 随着应用云化的日益普及，生于云端的应用具有与传统IT不同的技术基因和开发运维模式。

技术方面，云计算及互联网公司大量开源轻量级技术不停涌现并日渐成熟：

- 互联网/内联网/网络更加成熟；
- 轻量级运行时技术的出现(node.js, WAS Liberty等)；
- 新的方法与工具(Agile, DevOps, TDD, CI, XP, Puppet, Chef…)；
- 新的轻量级协议(RESTful API接口, 轻量级消息机制)；
- 简化的基础设施：操作系统虚拟化(hypervisors), 容器化(e.g. Docker), 基础设施即服务 (IaaS), 工作负载虚拟化(Kubernetes,Spark…)等；
- 服务平台化(PaaS)： 云服务平台上具有自动缩放、工作负载管理、SLA 管理、消息机制、缓存、构建管理等各种按需使用的服务；
- 新的可替代数据持久化模型：如NoSQL, MapReduce, BASE, CQRS等；
- 标准化代码管理：如Github等。

### 微服务优缺点

#### 优势

1. 快速发布：每个服务都比较简单，只关注单个业务功能，由不同的团队负责开发加快推出速度；
2. 松耦合：服务与服务之间通过语言无关的通信协议相互通讯，代码侵入性低；
3. 去中心化：每个服务只实现单个功能，使得每个服务都很重要缺一不可；
4. 持续交付：在频繁发布不同服务的同时保持系统其他部分的可用性和稳定性。

#### 缺点

1. 运维开销及成本增加：整体应用可能只需部署至一小片应用服务区集群，而微服务架构可能变成需要构建/测试/部署/运行数十个独立的服务，并可能需要支持多种语言和环境。这导致一个整体式系统如果由20个微服务组成，可能需要40~60个进程。
2. 隐式接口及接口匹配问题：把系统分为多个协作组件后会产生新的接口，这意味着简单的交叉变化可能需要改变许多组件，并需协调一起发布。在实际环境中，一个新品发布可能被迫同时发布大量服务，由于集成点的大量增加，微服务架构会有更高的发布风险。
3. 代码重复：某些底层功能需要被多个服务所用，为了避免将“同步耦合引入到系统中”，有时需要向不同服务添加一些代码，这就会导致代码重复。
4. 分布式系统的复杂性：作为一种分布式系统，微服务引入了复杂性和其他若干问题，例如网络延迟、容错性、消息序列化、不可靠的网络、异步机制、版本化、差异化的工作负载等，开发人员需要考虑以上的分布式系统问题。
5. 异步机制：微服务往往使用异步编程、消息与并行机制，如果应用存在跨微服务的事务性处理，其实现机制会变得复杂化。
6. 可测性的挑战：在动态环境下服务间的交互会产生非常微妙的行为，难以可视化及全面测试。经典微服务往往不太重视测试，更多的是通过监控发现生产环境的异常，进而快速回滚或采取其他必要的行动。但对于特别在意风险规避监管或投产环境错误会产生显著影响的场景下需要特别注意。

### 微服务实现框架

当知道微服务是什么东西之后，我们也就了解了要实现它的一个关键因素就是各个服务之间的通信问题。同过怎么样的方式来实现可以达到既能完成通信，同时又让人容易接受。以我们目前的方式其实有很多方式，比如：常用的http，socket，rpc等等还有其他的常用的不常用的通信协议。同时相关的框架也有许多，比如dubbo，grpc，thrift，Motan，ice等等许多的类似框架。

[Dubbo](http://dubbo.io/) 是阿里巴巴公司开源的一个Java高性能优秀的服务框架，使得应用可通过高性能的 RPC 实现服务的输出和输入功能，可以和 Spring框架无缝集成。不过，略有遗憾的是，据说在淘宝内部，dubbo由于跟淘宝另一个类似的框架HSF（非开源）有竞争关系，导致dubbo团队已经解散，反到是当当网的扩展版本仍在持续发展，墙内开花墙外香。其它的一些知名电商如当当、京东、国美维护了自己的分支或者在dubbo的基础开发，但是官方的库缺乏维护，相关的依赖类比如Spring，Netty还是很老的版本(Spring 3.2.16.RELEASE, netty 3.2.5.Final),倒是有些网友写了升级Spring和Netty的插件。

[Motan](https://github.com/weibocom/motan)是新浪微博开源的一个Java 框架。它诞生的比较晚，起于2013年，2016年5月开源。Motan 在微博平台中已经广泛应用，每天为数百个服务完成近千亿次的调用。

[gRPC](http://www.grpc.io/)是Google开发的高性能、通用的开源RPC框架，其由Google主要面向移动应用开发并基于HTTP/2协议标准而设计，基于ProtoBuf(Protocol Buffers)序列化协议开发，且支持众多开发语言。本身它不是分布式的，所以要实现上面的框架的功能需要进一步的开发。

[thrift](https://thrift.apache.org/)是Apache的一个跨语言的高性能的服务框架，也得到了广泛的应用。

[ZeroC ice](https://zeroc.com/)基于GPLv2协议开源的老牌RPC服务框架，用于商业得要购买许可证。

|               |                  Motan                   |                  Dubbo                   |        gRPC        |   Thrift    |
| ------------- | :--------------------------------------: | :--------------------------------------: | :----------------: | :---------: |
| **配置方式**      |                xml配置、注解配置                |          xml配置、注解配置、属性配置、api配置           |       api配置        |    api配置    |
| **服务器通信协议**   |                 Motan协议                  | Dubbo、Rmi、Hessian、HTTP、WebService、Dubbo Thrift、Memcached |     HTTP/2.0协议     |   Socket    |
| **序列化**       |              hessian2、Json               |            hessian2、java、json            |      protobuf      |   thrift    |
| **负载均衡**      | ActiveWeight、Random、RoundRobin、LocalFirst、Consistent、ConfigurableWeight | Random、RoundRobin、ConsistentHash、LeastActive |     可插拔负载均衡器机制     |      -      |
| **容错**        |            Failover、Failfast             | Failover、Failfast、Failsafe、Failback、Forking、Broadcast |      Failover      |      -      |
| **注册中心与服务发现** |          Consul、Zookeeper、点对点直连          |     Zookeeper、Redis、Multicas、Simple      |         -          |      -      |
| **多语言支持**     |           支持phpclient和C server           |                   java                   |         支持         |     支持      |
| **社区活跃度**     |                    活跃                    |                    停滞                    |         活跃         |     活跃      |
| **性能**        |                    2                     |                    2                     |         3          |     1-快     |
| **文档支持**      |                 中文文档齐全详细                 |                 中文文档齐全详细                 | 英文文档(有中文翻译版本)，不够详细 | 英文文档，指导不够详细 |
| **学习成本**      |                    2                     |                   1-低                    |        3-高         |      3      |
| **服务治理与管理**   |                    1                     |                   1-低                    |         2          |     3-高     |

性能测试结果

![snipaste_20170224_105130](images\snipaste_20170224_105130.png)

