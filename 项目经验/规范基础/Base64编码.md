## 重新认识Base64

Base64是网络上最常见的用于传输8bit字节码的编码方式之一，是一种基于64个可打印字符来表示二进制数据的方法。

### 1. 编码规则

Base64通过将原字节中连续的6个bit位编写为特定的字符，从而改变原有的编码来进行数据传输；不具有可读性，需重新解码才能阅读。标准的Base64是由数字、大小写字母共62个字符再加上+，/组成，其编码对应表如下：

| 原码   | 对应字符 | 原码   | 对应字符 | 原码   | 对应字符 | 原码   | 对应字符 |
| ------ | -------- | ------ | -------- | ------ | -------- | ------ | -------- |
| 000000 | **A**    | 010001 | **R**    | 100010 | **i**    | 110011 | **z**    |
| 000001 | **B**    | 010010 | **S**    | 100011 | **j**    | 110100 | **0**    |
| 000010 | **C**    | 010011 | **T**    | 100100 | **k**    | 110101 | **1**    |
| 000011 | **D**    | 010100 | **U**    | 100101 | **l**    | 110110 | **2**    |
| 000100 | **E**    | 010101 | **V**    | 100110 | **m**    | 110111 | **3**    |
| 000101 | **F**    | 010110 | **W**    | 100111 | **n**    | 111000 | **4**    |
| 000110 | **G**    | 010111 | **X**    | 101000 | **o**    | 111001 | **5**    |
| 000111 | **H**    | 011000 | **Y**    | 101001 | **p**    | 111010 | **6**    |
| 001000 | **I**    | 011001 | **Z**    | 101010 | **q**    | 111011 | **7**    |
| 001001 | **J**    | 011010 | **a**    | 101011 | **r**    | 111100 | **8**    |
| 001010 | **K**    | 011011 | **b**    | 101100 | **s**    | 111101 | **9**    |
| 001011 | **L**    | 011100 | **c**    | 101101 | **t**    | 111110 | **+**    |
| 001100 | **M**    | 011101 | **d**    | 101110 | **u**    | 111111 | **/**    |
| 001101 | **N**    | 011110 | **e**    | 101111 | **v**    |        |          |
| 001110 | **O**    | 011111 | **f**    | 110000 | **w**    |        |          |
| 001111 | **P**    | 100000 | **g**    | 110001 | **x**    |        |          |
| 010000 | **Q**    | 100001 | **h**    | 110010 | **y**    |        |          |

其遵守如下规则：

- 把三个字节变成4个字节，因为是每6bit编码为一个字符，所以24个bit会有4个字符，即4个字节，所以从这个层面来看，base64是增加了传输量的；
- 转换后每76个字符加一个换行符。

例如：转换前10101101,10111010,01110110；按照编码表转换后为：rbp2。

那么如果原字符串用字节表示后，字节数不是三的倍数，则意味着最后总有多余的位无法完成编码；这种情况采用如下方式处理：

1. 不足三的倍数，则在后面以0补足，直到字节数是3的倍数，这就意味着要补足8个0（补一个字节）或者是16个0（补两个字节）；
2. 将补足后的字节按照base64进行编码，然后在编码后的字符串末尾添加等号（=），添加的个数等于补的字节个数（1个或者2个）。

### 2. 变体

按照标准的Base64编码中包含有特殊的字符+和/，还有可能会有=；我们知道在url路径中这三个字符都是特殊字符，在传输时会被转换为“%xx”这种形式。为了解决这样的问题，业界出现了一种针对URL使用场景的Base64编码：Base64URL编码方式。其遵循如下规则：

- 用减号（-）代替加好（+）；
- 用下划线（_）代替反斜杠（/）；
- 不再补足字节，不足时直接低位用0代表再编码即可；
- 禁止换行符。

其他方面和标准Base64没有任何区别。比如：原字符串`<<???>>`编码为Base64后是`PDw/Pz8+Pg==`，而如果用Base64Url编码则是： `PDw_Pz8-Pg`。

因此在URL使用场景中，我们可以选择Base64Url编码方式，而不是Base64，这样可以避免很多不必要的工作。这应该也是为什么JSON Web Token标准中要将原内容进行Base64Url编码的原因吧。